language: node_js
node_js: '11'
branches:
  only:
  - master
notifications:
  slack:
    rooms:
    - secure: "GP7C/RKIY/LqXD/i79hvg2SMIoOp0F+c/7n1XXod82paXD4uyeVmWyrWBuBz59hRqVQLu8kr/YN/oO/yYtorWwX2wz0ABY/bdHlsTovUFxP5VE//yswRN71m2NNVnt2nO2xU8sffHLS67NphboO0GWDdx3I+sQni01xng+23EAOuT1gwlH3xbizxV3XwUQSCM9esPyp0gaEZZDOqRLUAt31sMdm6h6fO9j2RdlX+y5LVCa3mRr9lDLXrPLi0zu84Nphp9et1BncqZUwjDBxjAJeQ6dEb3HoQuhiqd0SbvwTATvxDElRu67j7d8C4dZl7xAXo0VWq61nYEGQ4KpPBUPmEcIiTmb9JpZY6jugEGfF742nBIBALAYOCaSUV8tQmw93R7kt9Y9qDsUWvCupCgpH0gGdcnML+rxynzH6khE/08WKzSVJqWN4Qq4NwO95C4drdUumVyZzvnWzSOa94AccVNcSQqkV4igjgyGxwhr8P1hDExhzfPLHLVlvBADIJYl5kE12U3/iXlv7PMeCETbG3yAYuJfvFbobU97w1/puDoEDSaSySOFQtbbLzGSTM4cHTUSK/+X4ft3KZc/bE0/v/WpsIBAqJnBAA4husQMs+EHdKIO4CE392EGnMNSoy4oCdLmcR2Elg5Kv4F4Pes98VGCJai0TzfFO6PtPbAS4="
    on_failure: always
    on_success: change
stages:
- name: test
- name: analysis
- name: release
  if: branch = master AND type != pull_request
jobs:
  include:
  - stage: test
    script: npm test
    name: test
  - script: npm run lint
    name: lint
  - stage: analysis
    script: npx jest --coverage && npx eslint -f json -o reports/eslint.json . &&
      npx gulp sonar
    name: sonar
    addons:
      sonarcloud:
        organization: flowscripter
        token:
          secure: "$SONAR_TOKEN"
  - stage: release
    deploy:
      provider: script
      skip_cleanup: true
      script:
      - npx semantic-release
